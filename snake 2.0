#include <iostream>
#include <windows.h>
#include <cstdlib>
#include <ctime>
#include <string>
#include <conio.h>

#define MAX 500

using namespace std;

// Biến toàn cục
int s1 = 7;
int diem = 0;
int tocdo = 150;
bool pauseGame = false;

// Hàm thay thế mylib.h
void gotoXY(int x, int y) {
    COORD coord;
    coord.X = x;
    coord.Y = y;
    SetConsoleCursorPosition(GetStdHandle(STD_OUTPUT_HANDLE), coord);
}

void SetColor(int color) {
    SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), color);
}

void HideCursor() {
    CONSOLE_CURSOR_INFO cursorInfo;
    GetConsoleCursorInfo(GetStdHandle(STD_OUTPUT_HANDLE), &cursorInfo);
    cursorInfo.bVisible = false;
    SetConsoleCursorInfo(GetStdHandle(STD_OUTPUT_HANDLE), &cursorInfo);
}

// Khai báo hàm
void veMenuChinh();
void veHieuUngMau();
void veTieuDe();
void veKhungGame();
void veThongTin();
void veTuongTren();
void veTuongDuoi();
void veTuongPhai();
void veTuongTrai();
void veTuong();
void khoiTaoRan(int toadox[], int toadoy[]);
void xoaDuLieuCu(int toadox[], int toadoy[]);
void veRan(int toadox[], int toadoy[]);
void xuLyRan(int toadox[], int toadoy[], int x, int y, int& xqua, int& yqua);
void them(int a[], int x);
void xoa(int a[], int vt);
bool ktRanChamTuong(int x0, int y0);
bool ktRanChamDuoi(int toadox[], int toadoy[]);
bool ktRan(int toadox[], int toadoy[]);
void taoQua(int& xqua, int& yqua, int toadox[], int toadoy[]);
bool ktRanDeQua(int xqua, int yqua, int toadox[], int toadoy[]);
bool ktRanAnQua(int xqua, int yqua, int x0, int y0);
void veGameOver();
void vePause();
void capNhatTocDo();
void playGame();
void veHuongDan();

// Hàm main
int main()
{
    // Cấu hình console cho Visual Studio
    system("mode con cols=120 lines=35");
    SetConsoleTitleA("SNAKE GAME - Phien Ban Sinh Dong");
    HideCursor();
    
    srand((unsigned int)time(NULL));
    
    while (true)
    {
        system("cls");
        veMenuChinh();
        
        char luaChon = _getch();
        
        switch (luaChon)
        {
        case '1':
            playGame();
            break;
        case '2':
            veHuongDan();
            break;
        case '3':
            SetColor(7);
            system("cls");
            cout << "\n\n\t\tCam on ban da choi game! Hen gap lai!\n\n";
            Sleep(2000);
            exit(0);
            break;
        default:
            continue;
        }
    }
    
    return 0;
}

void veMenuChinh()
{
    veTieuDe();
    
    SetColor(11);
    cout << "\n\n\t\t+==================================+\n";
    cout << "\t\t|          MENU CHINH              |\n";
    cout << "\t\t+==================================+\n";
    SetColor(14);
    cout << "\t\t|  1. Bat dau choi                 |\n";
    SetColor(13);
    cout << "\t\t|  2. Huong dan                    |\n";
    SetColor(12);
    cout << "\t\t|  3. Thoat game                   |\n";
    SetColor(11);
    cout << "\t\t+==================================+\n\n";
    
    SetColor(10);
    cout << "\t\t*** Nhan so de chon: ";
    SetColor(7);
}

void veTieuDe()
{
    SetColor(14);
    cout << "\n\n";
    cout << "\t\t ######     ###    ##    ##    ########  ##   ## ##   ##\n";
    cout << "\t\t##         ## ##   ###   ##       ##     ##   ## ##   ##\n";
    SetColor(13);
    cout << "\t\t ######   ##   ##  ## ## ##       ##     ####### ##   ##\n";
    cout << "\t\t      ## ######### ##  ####       ##     ##   ## ##   ##\n";
    SetColor(12);
    cout << "\t\t ###### ##     ## ##   ###       ##     ##   ##  #####\n";
    SetColor(11);
    cout << "\t\t              *** SINH DONG & NHIEU MAU SAC ***\n";
}

void veHuongDan()
{
    system("cls");
    SetColor(14);
    cout << "\n\n\t\tHUONG DAN CHOI GAME\n";
    cout << "\t\t===================\n\n";
    SetColor(11);
    cout << "\t\tCach dieu khien:\n";
    cout << "\t\t- Mui ten len    : Di chuyen len\n";
    cout << "\t\t- Mui ten xuong  : Di chuyen xuong\n";
    cout << "\t\t- Mui ten trai   : Di chuyen trai\n";
    cout << "\t\t- Mui ten phai   : Di chuyen phai\n";
    cout << "\t\t- Phim P         : Tam dung\n";
    cout << "\t\t- Phim ESC       : Thoat\n\n";
    SetColor(13);
    cout << "\t\tMuc tieu:\n";
    cout << "\t\t- An qua de tang diem va tang kich thuoc ran\n";
    cout << "\t\t- Tranh va cham vao tuong va than ran\n";
    cout << "\t\t- Cang an nhieu qua, toc do cang tang!\n\n";
    SetColor(7);
    cout << "\t\tNhan phim bat ky de quay lai menu...";
    _getch();
}

void playGame()
{
    system("cls");
    bool gameover = false;
    diem = 0;
    s1 = 7;
    tocdo = 150;

    int toadox[MAX], toadoy[MAX];
    veKhungGame();
    veTuong();
    khoiTaoRan(toadox, toadoy);
    veRan(toadox, toadoy);
    
    int xqua = 0, yqua = 0;
    taoQua(xqua, yqua, toadox, toadoy);
    
    int x = 50, y = 13;
    int check = 2;
    
    while (gameover == false)
    {
        veThongTin();
        
        // Xử lý phím
        if (_kbhit())
        {
            char kitu = _getch();
            
            if (kitu == 27) // ESC
            {
                break;
            }
            else if (kitu == 'p' || kitu == 'P')
            {
                pauseGame = !pauseGame;
                if (pauseGame)
                {
                    vePause();
                    _getch();
                    pauseGame = false;
                    veThongTin(); // Vẽ lại thông tin sau khi pause
                }
            }
            else if (kitu == -32) // Extended key
            {
                kitu = _getch();
                if (kitu == 72 && check != 0) check = 1; // Lên
                else if (kitu == 80 && check != 1) check = 0; // Xuống
                else if (kitu == 77 && check != 3) check = 2; // Phải
                else if (kitu == 75 && check != 2) check = 3; // Trái
            }
        }
        
        if (!pauseGame)
        {
            xoaDuLieuCu(toadox, toadoy);
            
            // Di chuyển
            if (check == 0) y++; // Xuống
            else if (check == 1) y--; // Lên
            else if (check == 2) x++; // Phải
            else if (check == 3) x--; // Trái
            
            xuLyRan(toadox, toadoy, x, y, xqua, yqua);
            gameover = ktRan(toadox, toadoy);
        }
        
        Sleep(tocdo);
    }
    
    if (gameover)
    {
        veGameOver();
        _getch();
    }
}

void veKhungGame()
{
    SetColor(9);
    // Vẽ khung ngoài
    for (int i = 0; i < 120; i++)
    {
        gotoXY(i, 0);
        cout << "=";
        gotoXY(i, 34);
        cout << "=";
    }
    
    for (int i = 0; i < 35; i++)
    {
        gotoXY(0, i);
        cout << "|";
        gotoXY(119, i);
        cout << "|";
    }
    
    // Góc
    gotoXY(0, 0); cout << "+";
    gotoXY(119, 0); cout << "+";
    gotoXY(0, 34); cout << "+";
    gotoXY(119, 34); cout << "+";
    SetColor(7);
}

void veThongTin()
{
    SetColor(14);
    gotoXY(105, 2);
    cout << "DIEM: " << diem;
    
    SetColor(13);
    gotoXY(105, 4);
    cout << "CHIEU DAI: " << s1;
    
    SetColor(12);
    gotoXY(105, 6);
    cout << "TOC DO: " << (200 - tocdo);
    
    SetColor(11);
    gotoXY(105, 8);
    cout << "P: Tam dung";
    
    SetColor(10);
    gotoXY(105, 10);
    cout << "ESC: Thoat";
    SetColor(7);
}

void veTuongTren()
{
    for (int x = 10; x <= 100; x++)
    {
        gotoXY(x, 1);
        SetColor(11 + (x % 4));
        cout << "#";
    }
}

void veTuongDuoi()
{
    for (int x = 10; x <= 100; x++)
    {
        gotoXY(x, 26);
        SetColor(11 + (x % 4));
        cout << "#";
    }
}

void veTuongPhai()
{
    for (int y = 1; y <= 26; y++)
    {
        gotoXY(100, y);
        SetColor(11 + (y % 4));
        cout << "#";
    }
}

void veTuongTrai()
{
    for (int y = 1; y <= 26; y++)
    {
        gotoXY(10, y);
        SetColor(11 + (y % 4));
        cout << "#";
    }
}

void veTuong()
{
    veTuongTren();
    veTuongDuoi();
    veTuongPhai();
    veTuongTrai();
    SetColor(7);
}

void khoiTaoRan(int toadox[], int toadoy[])
{
    int x = 50, y = 13;
    for (int i = 0; i < s1; i++)
    {
        toadox[i] = x;
        toadoy[i] = y;
        x--;
    }
}

void veRan(int toadox[], int toadoy[])
{
    for (int i = 0; i < s1; i++)
    {
        gotoXY(toadox[i], toadoy[i]);
        if (i == 0)
        {
            SetColor(14); // Đầu rắn màu vàng
            cout << "@";
        }
        else
        {
            SetColor(10 + (i % 6)); // Thân rắn nhiều màu
            cout << "o";
        }
    }
    SetColor(7);
}

void xoaDuLieuCu(int toadox[], int toadoy[])
{
    for (int i = 0; i < s1; i++)
    {
        gotoXY(toadox[i], toadoy[i]);
        cout << " ";
    }
}

void xuLyRan(int toadox[], int toadoy[], int x, int y, int& xqua, int& yqua)
{
    them(toadox, x);
    them(toadoy, y);
    
    if (ktRanAnQua(xqua, yqua, toadox[0], toadoy[0]) == false)
    {
        xoa(toadox, s1 - 1);
        xoa(toadoy, s1 - 1);
    }
    else
    {
        diem += 10;
        capNhatTocDo();
        
        // Hiệu ứng ăn quả
        SetColor(15);
        gotoXY(xqua, yqua);
        cout << "*";
        Sleep(100);
        
        taoQua(xqua, yqua, toadox, toadoy);
    }
    
    veRan(toadox, toadoy);
}

void capNhatTocDo()
{
    if (tocdo > 50)
    {
        tocdo -= 5;
    }
}

void them(int a[], int x)
{
    for (int i = s1; i > 0; i--)
    {
        a[i] = a[i - 1];
    }
    a[0] = x;
    s1++;
}

void xoa(int a[], int vt)
{
    for (int i = vt; i < s1; i++)
    {
        a[i] = a[i + 1];
    }
    s1--;
}

bool ktRanChamTuong(int x0, int y0)
{
    return (y0 <= 1 || y0 >= 26 || x0 <= 10 || x0 >= 100);
}

bool ktRanChamDuoi(int toadox[], int toadoy[])
{
    for (int i = 1; i < s1; i++)
    {
        if (toadox[0] == toadox[i] && toadoy[0] == toadoy[i])
        {
            return true;
        }
    }
    return false;
}

bool ktRan(int toadox[], int toadoy[])
{
    return ktRanChamDuoi(toadox, toadoy) || ktRanChamTuong(toadox[0], toadoy[0]);
}

void taoQua(int& xqua, int& yqua, int toadox[], int toadoy[])
{
    do
    {
        xqua = rand() % (99 - 11 + 1) + 11;
        yqua = rand() % (25 - 2 + 1) + 2;
    } while (ktRanDeQua(xqua, yqua, toadox, toadoy));
    
    int mauQua = rand() % 6 + 10;
    SetColor(mauQua);
    gotoXY(xqua, yqua);
    cout << "$";
    SetColor(7);
}

bool ktRanDeQua(int xqua, int yqua, int toadox[], int toadoy[])
{
    for (int i = 0; i < s1; i++)
    {
        if (xqua == toadox[i] && yqua == toadoy[i])
        {
            return true;
        }
    }
    return false;
}

bool ktRanAnQua(int xqua, int yqua, int x0, int y0)
{
    return (x0 == xqua && y0 == yqua);
}

void veGameOver()
{
    system("cls");
    SetColor(12);
    cout << "\n\n\t\t  ####    ##   ##   ## ###  ######       ####   ##  ##  ######  ###### \n";
    cout << "\t\t ##       ## # ##   ##  ##   ##          ##  ##  ##  ##   ##  ##   ##    \n";
    cout << "\t\t ##  ###  ##   ##   ##      ####        ##  ##  ##  ##   ####    ####  \n";
    cout << "\t\t ##   ##  ##   ##   ## ##   ##          ##  ##   ####    ##      ##    \n";
    cout << "\t\t  ####    ##   ##  ###  ##  ######       ####     ##     ######  ###### \n\n";
    
    SetColor(14);
    cout << "\t\t+==========================================+\n";
    cout << "\t\t|              KET QUA GAME               |\n";
    cout << "\t\t+==========================================+\n";
    SetColor(13);
    cout << "\t\t| Diem so cua ban: " << diem;
    
    // Căn chỉnh format
    int spaces = 22 - to_string(diem).length();
    for (int i = 0; i < spaces; i++) cout << " ";
    cout << "|\n";
    
    cout << "\t\t| Chieu dai ran: " << s1;
    spaces = 24 - to_string(s1).length();
    for (int i = 0; i < spaces; i++) cout << " ";
    cout << "|\n";
    
    SetColor(14);
    cout << "\t\t+==========================================+\n\n";
    
    SetColor(11);
    cout << "\t\tCam on ban da choi! Nhan phim bat ky de tiep tuc...";
    SetColor(7);
}

void vePause()
{
    SetColor(11);
    gotoXY(40, 13);
    cout << "+=====================+";
    gotoXY(40, 14);
    cout << "|    GAME TAM DUNG    |";
    gotoXY(40, 15);
    cout << "| Nhan P de tiep tuc  |";
    gotoXY(40, 16);
    cout << "+=====================+";
    SetColor(7);
}
